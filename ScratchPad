// Add a new column named "Route" based on conditions applied to the "org" column
Table.AddColumn(
    #"PreviousStep",  // Replace "PreviousStep" with the actual name of your last step
    "Route", 
    each if Text.Contains([org], "Symantec") then "WSS Proxy" 
    else if Text.Contains([org], "Blue Coat") then "WSS Proxy" 
    else if Text.Contains([org], "Azure Cloud") then "abrdn Azure" 
    else if Text.Contains([org], "Cognizant") then "Cognizant" 
    else if Text.Contains([org], "Google Cloud") then "Google Cloud" 
    else "abrdn DC"
)



let
    // Define a list of IP ranges (replace or add more IPs as necessary)
    ipRanges = {
        "148.64.5.0/24", "148.64.9.0/24", "148.64.24.0/24", "148.64.27.0/24",
        "148.64.28.0/24", "148.64.29.0/24", "103.246.37.0/24", "103.246.38.0/24",
        "148.64.15.0/24", "148.64.16.0/24", "148.64.18.0/24", "148.64.21.0/24",
        "148.64.3.0/24", "148.64.31.0/24", "168.149.128.0/24", "168.149.133.0/24",
        "168.149.142.0/24", "168.149.143.0/24", "168.149.144.0/24", "168.149.145.0/24",
        "168.149.146.0/24", "168.149.150.0/24", "168.149.151.0/24", "168.149.152.0/24",
        "168.149.153.0/24", "168.149.157.0/24", "168.149.160.0/24", "168.149.164.0/24",
        "168.149.178.0/24", "168.149.179.0/26", "168.149.179.64/27", "170.176.240.0/24",
        "170.176.241.0/24", "199.116.168.0/24", "199.116.170.0/24", "199.116.171.0/24",
        "199.116.173.0/24", "199.19.248.0/24", "199.19.253.0/24", "199.247.32.0/24",
        "199.247.33.0/24", "199.247.42.0/24", "199.247.43.0/24", "199.247.44.0/24",
        "199.247.45.0/24", "35.192.241.0/24", "52.169.10.218", "52.166.243.189",
        "172.200.133.108", "52.176.212.104", "40.119.193.62", "13.75.88.62",
        "64.69.175.81", "185.38.106.68", "203.99.207.50", "203.99.206.243",
        "213.86.51.131", "157.120.242.130", "38.98.247.194"
    },

    // Remove duplicates from the list to ensure unique values
    uniqueIPRanges = List.Distinct(ipRanges),

    // Create a table from the list of unique IP ranges
    ipRangeTable = Table.FromList(
        uniqueIPRanges,  // Use the unique list of IP ranges
        Splitter.SplitByNothing(),
        {"IP Range"}, // Column name
        null,
        ExtraValues.Error
    ),
    #"Invoked Custom Function" = Table.AddColumn(ipRangeTable, "IPRangeHandler", each IPRangeHandler([IP Range])),
    #"Expanded IPRangeHandler" = Table.ExpandRecordColumn(#"Invoked Custom Function", "IPRangeHandler", {"FirstUsableIP", "LastUsableIP"}, {"FirstUsableIP", "LastUsableIP"}),
    #"Invoked Custom Function1" = Table.AddColumn(#"Expanded IPRangeHandler", "FirstUsableIP-Numeric", each convIP4toNumber([FirstUsableIP])),
    #"Invoked Custom Function2" = Table.AddColumn(#"Invoked Custom Function1", "LastUsableIP-Numeric", each convIP4toNumber([LastUsableIP])),
    #"Invoked Custom Function3" = Table.AddColumn(#"Invoked Custom Function2", "fn_GetIPAddressDetails", each fn_GetIPAddressDetails([FirstUsableIP])),
    #"Expanded fn_GetIPAddressDetails" = Table.ExpandTableColumn(#"Invoked Custom Function3", "fn_GetIPAddressDetails", {"city", "country", "countryCode", "isp", "lat", "lon", "org", "regionName", "timezone"}, {"city", "country", "countryCode", "isp", "lat", "lon", "org", "regionName", "timezone"})
in
    #"Expanded fn_GetIPAddressDetails"
