let binSize = 24h;
let timeRangeStart = now(-1d);
let timeRangeEnd = now();
Perf
| where TimeGenerated between (timeRangeStart..timeRangeEnd)
| extend 
    LocalTime = case(
        Computer startswith "M01" or Computer startswith "M04", datetime_add('hour', 0, TimeGenerated),  // EMEA (UTC+0)
        Computer startswith "M13" or Computer startswith "M14", datetime_add('hour', 8, TimeGenerated),  // APAC (UTC+8)
        Computer startswith "M06" or Computer startswith "M09", datetime_add('hour', -5, TimeGenerated), // AMRS (UTC-5)
        datetime_add('hour', 0, TimeGenerated) // Default fallback
    ),
    Region = case(
        Computer startswith "M01" or Computer startswith "M04", "EMEA",
        Computer startswith "M13" or Computer startswith "M14", "APAC",
        Computer startswith "M06" or Computer startswith "M09", "AMRS",
        "Other"
    )
| where Region in ("EMEA", "APAC", "AMRS") // Filter for relevant regions
| where ObjectName == "Processor Information" and CounterName == "% Processor Time"
| extend 
    Environment = case(
        substring(Computer, 3, 1) == "T", "TST", 
        substring(Computer, 3, 1) == "U", "UAT", 
        substring(Computer, 3, 1) == "D", "DEV", 
        Computer contains "NACR", "CRIMS NonProdA",
        Computer contains "NBCR", "CRIMS NonProdB",
        Computer contains "OHCR", "OAT CRIMS High",
        Computer contains "OMCR", "OAT CRIMS Medium",
        Computer contains "OLCR", "OAT CRIMS Low",
        Computer contains "PHCR", "PRD CRIMS High",
        Computer contains "PMCR", "PRD CRIMS High",
        Computer contains "PLCR", "PRD CRIMS Low",
        substring(Computer, 3, 1) == "P", "PRD", 
        "Other"
    ),
    SessionHostPoolType = case(
        Computer contains "MSN", "MultiSession",
        Computer contains "SSP", "Personal",
        Computer contains "NACR", "MultiSession",
        Computer contains "NBCR", "MultiSession",
        Computer contains "OHCR", "MultiSession",
        Computer contains "OMCR", "MultiSession",
        Computer contains "OLCR", "MultiSession",
        Computer contains "PHCR", "MultiSession",
        Computer contains "PMCR", "MultiSession",
        Computer contains "PLCR", "MultiSession",
        "Other"
    ),
    Management = case(
        substring(Computer, 7, 1) == "I", "Intune",
        substring(Computer, 7, 1) == "G", "GPO",
        "Other"
    )
| extend 
    DayOfWeek = toint(format_datetime(LocalTime, 'dddd')) - 1,  // Extract day of the week as 0 (Sunday) to 6 (Saturday)
    HourOfDay = datetime_part("hour", LocalTime) // Get the hour of the day
| where DayOfWeek >= 1 and DayOfWeek <= 5 // Filter for Monday to Friday
| where HourOfDay >= 8 and HourOfDay <= 17 // Filter for core hours: 8 AM to 5 PM
| summarize 
    AVG_CPU = round(avg(CounterValue), 2), 
    MAX_CPU = round(max(CounterValue), 2), 
    MIN_CPU = round(min(CounterValue), 2),
    MED_CPU = round(percentile(CounterValue, 50), 2),
    ItemsPerTimeBin = count() 
  by bin(LocalTime, binSize), Computer, Region, Environment, SessionHostPoolType, Management, DayOfWeek, HourOfDay
| extend Computer = trim(' ', tolower(Computer))
| project 
    TimeGenerated = bin(LocalTime, binSize),
    SessionHostName = Computer,
    Region,
    Environment,
    SessionHostPoolType,
    Management,
    AVG_CPU,
    MED_CPU,
    MAX_CPU,
    MIN_CPU,
    ItemsPerTimeBin,
    HourOfDay,
    DayOfWeek





let binSize = 24h;
let timeRangeStart = now(-1d);
let timeRangeEnd = now();
Perf
| where TimeGenerated between (timeRangeStart..timeRangeEnd)
| extend 
    LocalTime = case(
        Computer startswith "M01" or Computer startswith "M04", datetime_add('hour', 0, TimeGenerated),  // EMEA (UTC+0)
        Computer startswith "M13" or Computer startswith "M14", datetime_add('hour', 8, TimeGenerated),  // APAC (UTC+8)
        Computer startswith "M06" or Computer startswith "M09", datetime_add('hour', -5, TimeGenerated), // AMRS (UTC-5)
        datetime_add('hour', 0, TimeGenerated) // Default fallback
    ),
    Region = case(
        Computer startswith "M01" or Computer startswith "M04", "EMEA",
        Computer startswith "M13" or Computer startswith "M14", "APAC",
        Computer startswith "M06" or Computer startswith "M09", "AMRS",
        "Other"
    )
| where Region in ("EMEA", "APAC", "AMRS") // Filter for relevant regions
| where ObjectName == "Processor Information" and CounterName == "% Processor Time"
| extend 
    Environment = case(
        substring(Computer, 3, 1) == "T", "TST", 
        substring(Computer, 3, 1) == "U", "UAT", 
        substring(Computer, 3, 1) == "D", "DEV", 
        Computer contains "NACR", "CRIMS NonProdA",
        Computer contains "NBCR", "CRIMS NonProdB",
        Computer contains "OHCR", "OAT CRIMS High",
        Computer contains "OMCR", "OAT CRIMS Medium",
        Computer contains "OLCR", "OAT CRIMS Low",
        Computer contains "PHCR", "PRD CRIMS High",
        Computer contains "PMCR", "PRD CRIMS High",
        Computer contains "PLCR", "PRD CRIMS Low",
        substring(Computer, 3, 1) == "P", "PRD", 
        "Other"
    ),
    SessionHostPoolType = case(
        Computer contains "MSN", "MultiSession",
        Computer contains "SSP", "Personal",
        Computer contains "NACR", "MultiSession",
        Computer contains "NBCR", "MultiSession",
        Computer contains "OHCR", "MultiSession",
        Computer contains "OMCR", "MultiSession",
        Computer contains "OLCR", "MultiSession",
        Computer contains "PHCR", "MultiSession",
        Computer contains "PMCR", "MultiSession",
        Computer contains "PLCR", "MultiSession",
        "Other"
    ),
    Management = case(
        substring(Computer, 7, 1) == "I", "Intune",
        substring(Computer, 7, 1) == "G", "GPO",
        "Other"
    )
| extend 
    DayOfWeek = toint(dayofweek(LocalTime)),  // Cast dayofweek(LocalTime) to integer
    HourOfDay = datetime_part("hour", LocalTime) // Get the hour of the day
//| where DayOfWeek >= 1 and DayOfWeek <= 5 // Filter for Monday to Friday
| where HourOfDay >= 8 and HourOfDay <= 17 // Filter for core hours: 8 AM to 5 PM
| summarize 
    AVG_CPU = round(avg(CounterValue), 2), 
    MAX_CPU = round(max(CounterValue), 2), 
    MIN_CPU = round(min(CounterValue), 2),
    MED_CPU = round(percentile(CounterValue, 50), 2),
    ItemsPerTimeBin = count() 
  by bin(LocalTime, binSize), Computer, Region, Environment, SessionHostPoolType, Management, DayOfWeek, HourOfDay
| extend Computer = trim(' ', tolower(Computer))
| project 
    TimeGenerated = bin(LocalTime, binSize),
    SessionHostName = Computer,
    Region,
    Environment,
    SessionHostPoolType,
    Management,
    AVG_CPU,
    MED_CPU,
    MAX_CPU,
    MIN_CPU,
    ItemsPerTimeBin,
    HourOfDay,
    DayOfWeek

Why is Day of the Week being returned as a long number?

TimeGenerated [UTC]	SessionHostName	Region	Environment	SessionHostPoolType	Management	AVG_CPU	MED_CPU	MAX_CPU	MIN_CPU	ItemsPerTimeBin	HourOfDay	DayOfWeek
27/11/2024, 00:00:00.000	m01psspi0310.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	4.07	2.97	11.19	1.58	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0237.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	4.83	3.73	9.24	1.8	12	8	2134720512
27/11/2024, 00:00:00.000	m14psspi0145.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	18.6	16.93	31.58	11.47	12	16	2134720512
27/11/2024, 00:00:00.000	m01psspi0432.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	5.81	4.81	13.18	3	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0404.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.52	2.75	7.93	1.57	11	8	2134720512
27/11/2024, 00:00:00.000	m14psspi0172.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	12.06	9.5	30.85	3.3	11	16	2134720512
27/11/2024, 00:00:00.000	m01usspi0023.aberdeen.aberdeen-asset.com	EMEA	UAT	Personal	Intune	2.96	2.15	7.55	1.4	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0386.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.45	2.64	6.93	1.78	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0500.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.67	2.58	13.9	2.04	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0018.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	4.01	3.17	9.78	1.95	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0009.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	6.36	5.83	12.86	4.09	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0068.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	9.17	5.6	26.28	3.35	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0512.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.31	2.55	7.61	1.3	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0034.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	21.88	16.8	59.39	1.93	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0627.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	7.39	6.93	12.28	4.07	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0542.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	4.97	3.88	13.37	1.99	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0737.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.15	2.9	8.63	1.12	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0109.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.69	3.05	7.34	1.58	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0150.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	46.95	44.35	99.98	3.48	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0197.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	12.19	3.73	38.24	0.66	11	8	2134720512
27/11/2024, 00:00:00.000	m14psspi0067.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	32.45	32.57	42.95	19.76	11	16	2134720512
27/11/2024, 00:00:00.000	m01tsspi0027.aberdeen.aberdeen-asset.com	EMEA	TST	Personal	Intune	1.93	0.69	11.15	0.19	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0189.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.29	2.54	6.87	2.03	11	8	2134720512
27/11/2024, 00:00:00.000	m14psspi0085.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	33.02	33.63	41.57	26.28	11	16	2134720512
27/11/2024, 00:00:00.000	m14psspi0087.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	39.2	39.02	49.76	29.48	12	16	2134720512
27/11/2024, 00:00:00.000	m01psspi0700.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	4.06	2.82	10.74	1.77	12	8	2134720512
27/11/2024, 00:00:00.000	m14psspi0081.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	28.5	28.2	31.51	26.82	12	16	2134720512
27/11/2024, 00:00:00.000	m01psspi0278.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.72	2.81	12.76	1.55	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0839.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.76	2.26	14.46	1.5	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0625.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	7.12	4.6	14.15	4.12	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0256.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	4.62	4.12	8.37	1.38	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0833.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	11.97	11.43	28.82	4	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0617.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	23.31	19.21	63	1.75	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0279.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.8	2.46	9	1.54	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0779.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	1.38	0.92	3.43	0.33	12	8	2134720512
27/11/2024, 00:00:00.000	m14psspi0104.aberdeen.aberdeen-asset.com	APAC	PRD	Personal	Intune	8.67	8.02	13.75	6.03	12	16	2134720512
27/11/2024, 00:00:00.000	m01psspi0339.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.74	2.38	14.45	1.38	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0353.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	5.92	3.22	20.47	1.63	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0695.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	2.3	1.9	4.55	0.7	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0797.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	22.06	20.63	65.56	2.34	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0336.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.97	3.37	8.75	1.5	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0313.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.64	2.54	9.11	2.1	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0650.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	5.81	4.15	15.13	2.66	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0316.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	12.19	11.93	25.66	4.67	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0795.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	2.94	2.15	7.86	1.47	12	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0390.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	3.77	2.94	11.21	1.16	11	8	2134720512
27/11/2024, 00:00:00.000	m01psspi0383.aberdeen.aberdeen-asset.com	EMEA	PRD	Personal	Intune	7.56	7.12	11.45	4	11	8	2134720512
