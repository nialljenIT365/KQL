WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId, PredecessorConnectionId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime, ConnectionType, StartTime, EndTime, _ResourceId, PredecessorConnectionId
| join kind=leftouter (
    WVDCheckpoints
    | where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"
    | project CorrelationId, Parameters
) on CorrelationId
| project StartTime, EndTime, UserName, Duration, Parameters, _ResourceId, PredecessorConnectionId





WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId, PredecessorConnectionId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime, ConnectionType, StartTime, EndTime, _ResourceId
| join kind=leftouter (
    WVDCheckpoints
    | where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"
    | project CorrelationId, Parameters
) on CorrelationId
| project StartTime, EndTime, UserName, Duration, Parameters, _ResourceId, PredecessorConnectionId




WVDConnections
            | extend UserName = trim("" "", tolower(UserName))
            | where State == ""Connected""
            | project CorrelationId, UserName, ResourceAlias, StartDate = TimeGenerated
            | join (
                WVDConnections
                | where State == ""Completed""
                | project EndDate = TimeGenerated, CorrelationId
            ) on CorrelationId
            | extend StartTimekey = format_datetime(StartDate, 'HHmm')
            | extend EndTimekey = format_datetime(EndDate, 'HHmm')
            | project CorrelationId, StartDate, StartTimekey, EndDate, EndTimekey, UserName, DurationSeconds = (EndDate - StartDate) / 1s
            | summarize arg_max(StartDate, *) by CorrelationId


WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime, ConnectionType, StartTime, EndTime, _ResourceId
| join kind=leftouter (
    WVDCheckpoints
    | where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"
    | project CorrelationId, Parameters
) on CorrelationId
| project CorrelationId, UserName, Duration, ConnectionType, StartTime, EndTime, _ResourceId, Parameters




WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime, ConnectionType, StartTime, _ResourceId
| join kind=leftouter (
    WVDCheckpoints
    | where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"
    | project CorrelationId, Parameters
) on CorrelationId
| project CorrelationId, UserName, Duration, ConnectionType, StartTime, _ResourceId, Parameters




// Step 1: Inline calculation for session duration
WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime, ConnectionType, StartTime, _ResourceId
| join kind=leftouter (
    WVDCheckpoints
    | where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"
    | project CorrelationId, Parameters
) on CorrelationId
| project CorrelationId, UserName, Duration, ConnectionType, StartTime, _ResourceId, Parameters


'join' operator: Failed to resolve table or column expression named 'WVDConnectionsData'
Request id: 12153aee-114d-4174-84d1-545de2de11e3

// Step 1: Calculate session duration from WVDConnections
let WVDConnectionsData = WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime, ConnectionType, StartTime, _ResourceId;

// Step 2: Filter WVDCheckpoints for VM start events
let WVDCheckpointsData = WVDCheckpoints
| where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"
| project CorrelationId, Parameters;

// Step 3: Join WVDConnectionsData with WVDCheckpointsData
WVDConnectionsData
| join kind=leftouter WVDCheckpointsData on CorrelationId
| project CorrelationId, UserName, Duration, ConnectionType, StartTime, _ResourceId, Parameters



WVDConnections 
| where TimeGenerated > ago(24h) 
| where State == "Started" 
| project CorrelationId , UserName, ConnectionType, 
StartTime=TimeGenerated, _ResourceId   
| join (WVDConnections 
| where State == "Connected" 
| project EndTime=TimeGenerated, CorrelationId) 
on CorrelationId 
| project CorrelationId, UserName, Duration = EndTime - StartTime

WVDCheckpoints
| where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting"



// Query 1: WVDConnections for session duration
let WVDConnectionsData = WVDConnections
| where TimeGenerated > ago(24h)
| where State == "Started"
| project CorrelationId, UserName, ConnectionType, StartTime = TimeGenerated, _ResourceId
| join (
    WVDConnections
    | where State == "Connected"
    | project EndTime = TimeGenerated, CorrelationId
) on CorrelationId
| project CorrelationId, UserName, Duration = EndTime - StartTime;

// Query 2: WVDCheckpoints for VM start events
let WVDCheckpointsData = WVDCheckpoints
| where Parameters contains "StartVMOnConnect" and Parameters contains "VMStarting";

// Joining both queries on CorrelationId
WVDConnectionsData
| join WVDCheckpointsData on CorrelationId
| project CorrelationId, UserName, Duration, Parameters, StartTime

