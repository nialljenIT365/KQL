let
    // WVDCOnnections KQL
    Source = AzureDataExplorer.Contents(
        "https://ade.loganalytics.io/subscriptions/58cb357e-51af-4f62-8982-a8c2b9059362/resourcegroups/rg-eus-desktopmanagement-nerdio-weu-prd/providers/microsoft.operationalinsights/workspaces/nmw-app-law-fwjv4wn75m4qg", 
        "nmw-app-law-fwjv4wn75m4qg", 
        "let ipPrefix = \"10.\";  // Set this to the desired IP prefix
        Heartbeat
        | where TimeGenerated >= ago(30d)
        | summarize arg_max(TimeGenerated, *) by Computer
        | extend FirstIPCandidate = tostring(split(tolower(tostring(ComputerPrivateIPs)), \",\")[0])
        | extend SecondIPCandidate = tostring(split(tolower(tostring(ComputerPrivateIPs)), \",\")[1])
        | extend IsFirstIPStartsWithPrefix = FirstIPCandidate has tolower(ipPrefix)
        | extend PrivateIPAddressCandidate = iff(IsFirstIPStartsWithPrefix, FirstIPCandidate, SecondIPCandidate)
        | extend PrivateIPAddress = replace(@'[\"\\[\\]]', '', PrivateIPAddressCandidate)
        | project Computer, tostring(ComputerPrivateIPs), PrivateIPAddress
        | distinct Computer, ComputerPrivateIPs, PrivateIPAddress", 
        [MaxRows=null, MaxSize=null, NoTruncate=null, AdditionalSetStatements=null]
    ),
    
    // Convert Computer column to lowercase for case-insensitive comparison
    LowerCaseComputers = Table.TransformColumns(Source, {{"Computer", Text.Lower, type text}}),
    
    // Remove duplicates based on case-insensitive Computer column
    #"Removed Duplicates" = Table.Distinct(LowerCaseComputers, {"Computer"})
in
    #"Removed Duplicates"
