let binSize = 24h;
let timeRangeStart = now(-30d);
let timeRangeEnd = now();
let filterSubstring = "M01"; // Replace with the desired substring, or set to "ALL" for all computers
Perf
| where TimeGenerated between (timeRangeStart..timeRangeEnd)
| where dayofweek(TimeGenerated) between (1d .. 5d)
| extend hour = datetime_part("hour", TimeGenerated)
| where hour between (08 .. 16)
| where ObjectName == "Processor Information" and CounterName == "% Processor Time"
| where filterSubstring == "ALL" or tostring(Computer) contains filterSubstring
| summarize AVG_CPU = round(avg(CounterValue), 2), 
            MAX_CPU = round(max(CounterValue), 2), 
            MIN_CPU = round(min(CounterValue), 2),
            MED_CPU = round(percentile(CounterValue, 50), 2),
            ItemsPerTimeBin = count() // Counting the number of entries per time bin
  by BinnedTime = bin(TimeGenerated, binSize), Computer
| project 
          TimeGenerated = BinnedTime,
          SessionHostName = Computer,
          AVG_CPU,
          MED_CPU,
          MAX_CPU,
          MIN_CPU,
          ItemsPerTimeBin

MultiSession-TST - M01TMSNI{####}
SingleSessionPersistent-TST - M01PSSPI{####}
MultiSession-UAT - M01UMSNI{####}
SingleSessionPersistent-UAT - M01USSPI{####}
MultiSession-PRD - M01PMSNI{####}
SingleSessionPersistent-PRD - M01PSSPI{####}

Region (EMEA, APAC or AMRS, Other) - (Begins with M01 or M04, M13 or M4, M06 or M09)
Environment (TST, UAT or PROD, Other) (followed by T, U or P)
SessionHostPoolType (Personal or MultiSession, Other) (Followed by SSP or MSN(
Management (Intune or GPO, Other) (Followed by I or G)





