#description: Removes user assigned to personal desktop from local Administrators group on session host VM based on device join type.
#execution mode: Combined
#tags: Nerdio
<#
Notes:
This script checks if the device is Hybrid Azure AD Joined or Entra ID Joined.
If Hybrid, it removes the AD user from the local Administrators group.
If Entra ID Joined, it removes the Azure AD user from the local Administrators group.
Ensure $DesktopUser is provided in UPN format (e.g., user@contoso.com) for Entra ID joined devices.
#>

# Output the Desktop User variable for verification
Write-Output "Desktop User: $DesktopUser"

# Check if $DesktopUser is populated
if (-not $DesktopUser) {
    Write-Error -Message 'ERROR: No Desktop User Specified. This VM may not be a personal Desktop.'
    exit
}

# Run dsregcmd /status to determine join type
$dsregStatus = dsregcmd /status

# Define a function to check if the user is in the Administrators group
function Is-UserInLocalAdminGroup {
    param (
        [string]$userName
    )
    $admins = Get-LocalGroupMember -Group "Administrators" | Where-Object { $_.Name -eq $userName }
    return $admins -ne $null
}

if ($dsregStatus -match "DomainJoined\s*:\s*YES" -and $dsregStatus -match "AzureAdJoined\s*:\s*YES") {
    # Device is Hybrid Azure AD Joined, use standard AD format
    Write-Output "Device is Hybrid Azure AD Joined."

    if (Is-UserInLocalAdminGroup -userName "$DesktopUser") {
        Write-Output "Removing AD user $DesktopUser from the local Administrators group."
        try {
            Remove-LocalGroupMember -Group "Administrators" -Member "$DesktopUser"
            Write-Output "Successfully removed $DesktopUser from the Administrators group."
        }
        catch {
            Write-Error -Message "ERROR: Failed to remove $DesktopUser from the Administrators group. $_"
        }
    }
    else {
        Write-Output "$DesktopUser is not a member of the Administrators group."
    }
}
elseif ($dsregStatus -match "AzureAdJoined\s*:\s*YES" -and $dsregStatus -notmatch "DomainJoined\s*:\s*YES") {
    # Device is Entra ID (Azure AD) Joined, use Azure AD format
    Write-Output "Device is Entra ID Joined."

    # Format the user for Azure AD
    $AzureADUser = "AzureAD\$DesktopUser"

    if (Is-UserInLocalAdminGroup -userName $AzureADUser) {
        Write-Output "Removing Azure AD user $AzureADUser from the local Administrators group."
        try {
            Remove-LocalGroupMember -Group "Administrators" -Member $AzureADUser
            Write-Output "Successfully removed $AzureADUser from the Administrators group."
        }
        catch {
            Write-Error -Message "ERROR: Failed to remove $AzureADUser from the Administrators group. $_"
        }
    }
    else {
        Write-Output "$AzureADUser is not a member of the Administrators group."
    }
}
else {
    Write-Error -Message "ERROR: Device is neither Hybrid Azure AD Joined nor Entra ID Joined."
    exit
}
